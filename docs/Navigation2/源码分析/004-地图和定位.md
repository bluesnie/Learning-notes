###### datetime:2024/01/10 18:18

###### author:nzb

# 导航

> https://github.com/ros-planning/navigation2.git
>
> 分支：humble
>
> 节点：3ed4c2d

![](./imgs/architectural_diagram-16525447663514.png)

# 地图和定位

- `nav2_map_server` ｜ 地图服务器
- `nav2_costmap_2d` ｜ 2D代价地图
- `nav2_voxel_grid` | 实现体素栅格的类
- `nav2_amcl` | 自适应蒙特卡洛定位。 状态估计，输入地图、激光、里程计数据，输出机器人map和odom之间的位姿关系。

## nav2_map_server

### 工具

- `loadMapYaml`：加载和解析给定的地图yaml文件参数，包括地图文件名，分辨率，地图原点，空闲阈值，占据阈值，模式，
- `loadMapFromFile`：从地图文件加载地图图像以及生成占用网格
- `loadMapFromYaml`：加载地图 YAML、地图文件中的图像以及生成占用网格`nav_msgs::msg::OccupancyGrid`返回
    - 调用`loadMapYaml`
    - 调用`loadMapFromFile`
- `saveMapToFile`：保存占据地图到文件
    - 调用`checkSaveParameters`
    - 调用`tryWriteMapToFile`
- `checkSaveParameters`：检查地图保存参数
- `tryWriteMapToFile`：分类型把地图写入文件，包括`Trinary`、`Scale`和`Raw`

```text
for (size_t y = 0; y < map.info.height; y++) {
  for (size_t x = 0; x < map.info.width; x++) {
    int8_t map_cell = map.data[map.info.width * (map.info.height - y - 1) + x];
    
nav_msgs::msg::OccupancyGrid 的data的是一维数组，其结构为

            |——————————————————————————————————> x(width)
            | (0,0) (0,1) (0,2) (0,3) ...  (0, w)
            | (1,0) (1,1)     ...
            |                 ...
            |                 ...
            | (h,0)           ...          (h, w)
  y(height) v
    
    data的数据排序为：[(0,0) ... (0,w) ... (h,0) ... (h, w)]
    
    比如width * height =5 * 4的20个元素，下图是索引表
  
 
  y(height) ^
            | 0   1   2   3   4 
            | 5   6   7   8   9
            | 10  11  12  13  14
            | 15  16  17  18  19
            |————————————————————> x(width)
    
    idx = width * (height - y - 1) + x
    y(height) = 0
        x(width) = 0, idx = 5 * (4 - 0 -1 ) + 0 = 15 
        x = 1, idx = 5 * (4 - 0 -1 ) + 1 = 16 
        x = 2, idx = 5 * (4 - 0 -1 ) + 2 = 17 
        x = 3, idx = 5 * (4 - 0 -1 ) + 3 = 18 
        x = 4, idx = 5 * (4 - 0 -1 ) + 4 = 19 
    y(height) = 1
        x(width) = 0, idx = 5 * (4 - 1 -1 ) + 0 = 10
        x = 1, idx = 5 * (4 - 1 -1 ) + 1 = 11 
        x = 2, idx = 5 * (4 - 1 -1 ) + 2 = 12 
        x = 3, idx = 5 * (4 - 1 -1 ) + 3 = 13 
        x = 4, idx = 5 * (4 - 1 -1 ) + 4 = 14 
    
    ... 
    
    y(height) = 3
        x(width) = 0, idx = 5 * (4 - 3 -1 ) + 0 = 0
        x = 1, idx = 5 * (4 - 3 -1 ) + 1 = 1
        x = 2, idx = 5 * (4 - 3 -1 ) + 2 = 2 
        x = 3, idx = 5 * (4 - 3 -1 ) + 3 = 3 
        x = 4, idx = 5 * (4 - 3 -1 ) + 4 = 4 
```

### 主要的类

- **MapServer**：解析地图yaml文件以及提供一个服务和一个话题发布占据网格地图，继承于`nav2_util::LifecycleNode`
    - `MapServer`：
        - 初始化节点`map_server`
        - 声明节点参数
            - `yaml_filename` -> `rclcpp::PARAMETER_STRING`
            - `topic_name` -> `map`
            - `frame_id` -> `map`
        - 创建一个`occ_service_`的`节点名称/map`的服务，绑定`getMapCallback`
        - 创建一个`occ_pub_`的`map`的发布话题
        - 创建一个`load_map_service_`的`节点名称/load_map`的服务，绑定`loadMapCallback`
    - `on_configure`：
        - 调用`loadMapResponseFromYaml`
        - 调用`updateMsgHeader`
    - `on_activate`：
        - `occ_pub_->on_activate()`
        - `occ_pub_->publish()`
        - `createBond()`
    - `on_deactivate`：
        - `occ_pub_->on_deactivate()`
        - `destroyBond()`
    - `on_cleanup`：属性重置
    - `on_shutdown`：
    - `loadMapResponseFromYaml`：加载地图yaml和图像，以及生成包含 `OccupancyGrid` 的输出响应。
    - `updateMsgHeader`：更新`msg`头信息，更新加载时间和帧id
    - `getMapCallback`：获取地图服务`map`的回调，返回最新的地图
    - `loadMapCallback`：更新加载地图服务`load_map`的回调
        - 调用`loadMapResponseFromYaml`，重新加载地图
        - 话题发布最新地图

- **MapSaver**：提供地图保存方法和服务的类，继承于`nav2_util::LifecycleNode`
    - `MapSaver`：
        - 初始化节点`map_saver`
        - 声明节点参数
            - `save_map_timeout` -> `2.0`
            - `free_thresh_default` -> `0.25`
            - `occupied_thresh_default` -> `0.65`
            - `map_subscribe_transient_local` -> `true`
    - `saveMapTopicToFile`：从地图话题读取信息并且保存到一个文件
        - 参数校验
        - 创建`map`(默认)名称的地图话题订阅
        - 调用`saveMapToFile`
    - `on_configure`：
        - 获取上述节点参数
        - 创建`save_map_service_`保存地图服务`节点名称/save_map`，绑定`saveMapCallback`
    - `on_activate`：调用`createBond()`
    - `on_deactivate`：调用`destroyBond()`
    - `on_cleanup`：属性重置
    - `on_shutdown`：
    - `saveMapCallback`：地图保存服务回调
        - 初始化保存地图参数
        - 调用`saveMapTopicToFile`

- **map_saver_cli**：可执行文件用于保存地图文件
    - `parse_arguments`：解析命令行参数
    - `main`：主函数
        - 调用`parse_arguments`
        - 实例化`map_saver = std::make_shared<nav2_map_server::MapSaver>()`
        - 调用`map_saver->on_configure`启动`map_saver`节点
        - 调用`map_saver->saveMapTopicToFile`保存地图文件

- **CostmapFilterInfoServer**：代价地图过滤器信息服务器，继承于`nav2_util::LifecycleNode`
    - `CostmapFilterInfoServer`
        - 初始化节点`costmap_filter_info_server`
        - 声明节点参数
            - `filter_info_topic` -> `costmap_filter_info`
            - `type` -> `0`
            - `mask_topic` -> `filter_mask`
            - `base` -> `0.0`
            - `multiplier` -> `1.0`
    - `on_configure`
        - 创建`costmap_filter_info`话题`publisher_ = this->create_publisher`，发布代价地图过滤器信息
    - `on_activate`
        - 调用`publisher_->on_activate()`
        - 调用`publisher_->publish`
        - 调用`createBond()`
    - `on_deactivate`
        - 调用`publisher_->on_deactivate()`
        - 调用`destroyBond()`
    - `on_cleanup`
    - `on_shutdown`

## nav2_voxel_grid

> TODO，先了解工作流以及有哪些功能，具体实现需要再深入，比较难懂

## nav2_amcl

> TODO，先了解工作流以及有哪些功能，具体实现需要再深入，比较难懂